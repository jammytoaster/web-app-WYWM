<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.w3.org/1999/xhtml" xmlns="http://www.w3.org/1999/html">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aperture Enterprises</title>
    <link rel="stylesheet" type = "text/css" th:href="@{/styles/style.css}">

  </head>
  <body>
    <div class="container">
      <header class="site_header">

      </header>

      <main>
        <section>
          <table id="product_table">
            <thead>
              <tr>
                <th>ID</th>
                <th>Name</th>
                <th>Price</th>
                <th>Quantity</th>
                <th>Sold</th>
                <th>Image</th>
              </tr>
            </thead>
            <tbody id="tbody">
            <tr>
            </tr>
            </tbody>
          </table>
        </section>
        <section>
          <div class="crud">
            <form id="create_prod" class="create_prod">
              <label>Category Name:</label>
              <input type="text" id="category_name" name="category_name" placeholder="Bike">

              <input type="hidden" id="product_category_id">
              <input type="hidden" id="row_count_category">

              <label>Product Name:</label>
              <input type="text" id="product_name" name="product_name" placeholder="BigWheel" required>

              <label>Product Price:</label>
              <input type="number" id="product_price" name="product_price" step=".01" placeholder="0.00" required>

              <label>Product Quantity:</label>
              <input type="number" id="product_quantity" name="product_quantity" placeholder="0" required>

              <label>Product Sold:</label>
              <input type="number" id="product_sold" name="product_sold" placeholder="0" required>

              <label>Product Image URL:</label>
              <input type="url" id="product_image" name="product_image" placeholder="https://image.com">

              <button id="create_item" type="submit">Create Item for Table</button>
            </form>

            <div>
              <form id="delete_prod" class="delete_prod">
                <label>Product ID of item to delete</label>
                <input type="number" id="delete_id" name="delete_id" placeholder="1">

                <button id="delete_item">Delete Item in Table</button>
              </form>
            </div>
            <div>
              <div>
                <form id="update_prod" class="update_prod">
                  <label>Product ID of item to update</label>
                  <input type="number" id="update_id" name="update_id" placeholder="1">

                  <button id="update_item_id">Find ID of Item To Update</button>
                </form>
              </div>
              <div>
                <form id="update_prod_input" class="update_prod_input">
                  <table style="visibility: hidden" id="update_product_table">
                    <tr>
                      <th>ID</th>
                      <th>Name</th>
                      <th>Price</th>
                      <th>Quantity</th>
                      <th>Sold</th>
                      <th>Image</th>
                    </tr>
                  </table>

                  <input style="visibility: hidden" id="update_product_category_id">

                  <label style="visibility: hidden" id="update_category_name_label">Category Name:</label>
                  <input style="visibility: hidden" type="text" id="update_category_name" name="update_category_name" placeholder="Bike">

                  <label style="visibility: hidden" id="update_product_name_label">Product Name:</label>
                  <input style="visibility: hidden" type="text" id="update_product_name" name="update_product_name" placeholder="BigWheel">

                  <label style="visibility: hidden" id="update_product_price_label">Product Price:</label>
                  <input style="visibility: hidden" type="number" id="update_product_price" name="update_product_price" step=".01" placeholder="0.00">

                  <label style="visibility: hidden" id="update_product_quantity_label">Product Quantity:</label>
                  <input style="visibility: hidden" type="number" id="update_product_quantity" name="update_product_quantity" placeholder="0">

                  <label style="visibility: hidden" id="update_product_sold_label">Product Sold:</label>
                  <input style="visibility: hidden" type="number" id="update_product_sold" name="update_product_sold" placeholder="0">

                  <label style="visibility: hidden" id="update_product_image_label">Product Image URL:</label>
                  <input style="visibility: hidden" type="url" id="update_product_image" name="update_product_image" placeholder="https://image.com">

                  <button style="visibility: hidden" id="update_item">Update Item in Table</button>
                </form>
              </div>
            </div>
          </div>
        </section>
      </main>
    </div>

    <script>

    <!------// Add products to main table-------->
    function addProductTable(product) {
      const tbody = document.getElementById("product_table");

      <!-------// Adds row as last row------->
      const row = tbody.insertRow(-1);

      <!-----// Adds the "low_stock" class to the row if there are less than 6 items in stock----->
      row.className = product.product_quantity < 6 ? "low_stock" : "";

      <!-----// Inserts cells to the row----->
      const id = row.insertCell(0);
      const name = row.insertCell(1);
      const price = row.insertCell(2);
      const quantity = row.insertCell(3);
      const sold = row.insertCell(4);
      const imageCell = row.insertCell(5);

      <!-----// Adds values to the table rows----->
      id.textContent = product.product_id;
      name.textContent =  product.product_name;
      price.textContent = product.product_price;
      quantity.textContent = product.product_quantity;
      sold.textContent = product.product_sold;

      <!-----// Adds image to table, including source and image size----->
      const image = document.createElement("img");
      image.src = product.product_image;
      image.width = 100;
      image.height = 100;
      imageCell.appendChild(image);
    }


    <!-------// Add products to update table-------->
    function addProductUpdateTable(product) {
      const table = document.getElementById("update_product_table");

      <!-------// Adds row as last row------->
      const row = table.insertRow(-1);

      <!-----// Adds the "low_stock" class to the row if there are less than 6 items in stock----->
      row.className = product.product_quantity < 6 ? "low_stock" : "";

      <!-----// Inserts cells to the row----->
      const id = row.insertCell(0);
      const name = row.insertCell(1);
      const price = row.insertCell(2);
      const quantity = row.insertCell(3);
      const sold = row.insertCell(4);
      const imageCell = row.insertCell(5);

      <!-----// Adds values to the table rows----->
      id.textContent = product.product_id;
      name.textContent =  product.product_name;
      price.textContent = product.product_price;
      quantity.textContent = product.product_quantity;
      sold.textContent = product.product_sold;

      <!-----// Adds image to table, including source and image size----->
      const image = document.createElement("img");
      image.src = product.product_image;
      image.width = 100;
      image.height = 100;
      imageCell.appendChild(image);
    }


    <!-----// Gets products from database----->
    fetch("/api/products").then((response) => {
      if (!response.ok) {
        throw new Error("Could not make network response");
      }
      return response.json();
      })

      <!-----// Goes through each row in the database and adds it to the HTML table----->
      .then((products) => {
        products.forEach((product) => {
          addProductTable(product);
        });
      })
      .catch((error) => {
        console.error("There was an issue when trying to fetch API: ", error);
      });


    <!---// Create Item method---->
    document.addEventListener("DOMContentLoaded", () => {
      async function checkCategory(category_name) {
        try {

        <!-------// Gets categories from category database-------->
          const response = await fetch("/api/categories");
          if (!response.ok) {
             throw new Error("Could not make network response");
          }
          const categories = await response.json();

          <!-------// Searches the database Array to see if the category name input by the user is present in the database------->
          let existingCategory = categories.find(
            (category) => category.category_name === category_name
          );

          <!-----// If the category name is present in the database, add the categories ID to the product_category_id input----->
          if (existingCategory) {
            document.getElementById("product_category_id").value = existingCategory.category_id;
          }

          <!-----// If the category name is not present in the database, add the category name to newCategory----->
          else {
            const newCategory = { category_name: category_name };

            <!------// Fetch categories and adds the newCategory to the database------>
            const addCategoryResponse = await fetch("/api/categories", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify(newCategory),
            });

            if (!addCategoryResponse.ok) {
              throw new Error("Unable to save new category");
            }

            const addedCategory = await addCategoryResponse.json();
            document.getElementById("product_category_id").value = addedCategory.category_id;
          }
        } catch (error) {
          console.error("There was an issue when trying to fetch API: ", error);
          }
        }

      <!------// Create button------>
      document.getElementById("create_prod").addEventListener("submit", async (e) => {
        e.preventDefault();

        <!-----// Adds the category_name to the checkCategory function----->
        const category_name = document.getElementById("category_name").value;
        await checkCategory(category_name);

        <!-----// Gets the product_category_id and turns it to an integer----->
        const productCategoryVal = parseInt(document.getElementById("product_category_id").value);

        <!-----// Adds the input items to the database----->
        const prod = {
          category: {
            category_id: productCategoryVal,
            category_name: category_name,
          },
          product_name: document.getElementById("product_name").value,
          product_price: parseFloat(document.getElementById("product_price").value),
          product_quantity: parseInt(document.getElementById("product_quantity").value),
          product_sold: parseInt(document.getElementById("product_sold").value),
          product_image: document.getElementById("product_image").value,
        };

        console.log(prod)

        <!------// Fetches the products database and adds the items to it------>
        fetch("/api/products", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify(prod),
        })
          .then((response) => {
            if (!response.ok) {
              throw new Error("Unable to save data");
            }
            return response.json();
          })

          <!-----// Adds the new product to the addProductTable function to add row to the table, then resets the fields----->
          .then((saveProduct) => {
            addProductTable(saveProduct);
            document.getElementById("create_prod").reset();
          })
          .catch((error) => {
            console.error("There was an error when trying to save product");
          });
        });
      });


    <!------// Delete item Method------->
    document.getElementById("delete_prod").addEventListener("submit", async (e) => {
      e.preventDefault();
      try {

        const ID = parseInt(document.getElementById("delete_id").value);

        <!-----// Deletes the product------>
        const response = await fetch(`/api/products/${ID}`, {
          method:"DELETE",
          headers:{
            "Content-Type" : "application/json",
          },
        });

        if (response.ok) {
          console.log("Product deleted");
          document.getElementById("delete_prod").reset();

          try {
            <!------// Gets the categories database------->
            const categoryResponse = await fetch("/api/categories");
            if (categoryResponse.ok) {
              const categories = await categoryResponse.json();

              <!-----// Looks through each category in the categories database and checks the length of them----->
              categories.forEach((category) => {
                if (category.products.length === 0) {
                  const CatID =  parseInt(category.category_id);

                  <!------// If the categories length is equal to 0 delete the category------>
                  const deleteCategoryResponse = fetch(`/api/categories/${CatID}`, {
                    method: "DELETE",
                    headers: {
                      "Content-Type": "application/json",
                    },
                  });
                }
              });
            }
          }
          catch (error){
            console.error("Error deleting category", error)
          }
        }
      }
      catch (error) {
        console.error("Error deleting product" + delete_id, error);
      }
      <!-----// Runs updateTable function to update table------>
      updateTable();
    });


    <!------// Update item method------->

    document.getElementById("update_prod").addEventListener("submit", async (e) => {
      e.preventDefault();

      try {
        const ID = parseInt(document.getElementById("update_id").value);
        const findItem = await fetch(`/api/products/${ID}`);

        if (findItem.ok) {
          const product = await findItem.json();

          addProductUpdateTable(product);

          showInputs();
          update_category_name = document.getElementById("update_category_name").value;
          checkCategory(update_category_name);

          const productCategoryVal = parseInt(document.getElementById("update_product_category_id").value);

          const updatedProduct = {
            category: {
              category_id: productCategoryVal,
              category_name: update_category_name,
            },
            product_name: document.getElementById("update_product_name").value,
            product_price: document.getElementById("update_product_price").value,
            product_quantity: document.getElementById("update_product_quantity").value,
            product_sold: document.getElementById("update_product_sold").value,
            product_image: document.getElementById("update_product_image").value,
          };

          try {
            const response = await fetch(`/api/products/${ID}`, {
              method: "PUT",
              headers: {
                "Content-Type": "application/json",
              },
            body: JSON.stringify(updatedProduct),
            });

            if (response.ok) {
              console.log("Product updated");
            }
          }
          catch (error) {
            console.log("Could not fetch item", error);
          }
        }
      }
      catch (error) {
        document.getElementById("update_prod").reset();
        document.getElementById("update_id").placeholder = "Id not found";
        console.log("Unable to find ID", error);
      }
    });



    document.getElementById("update_prod").addEventListener("submit", async (e) => {
      e.preventDefault();


    <!-----// Show inputs function----->
    function showInputs() {
      document.getElementById("update_product_table").style.visibility = "visible";

      document.getElementById("update_category_name_label").style.visibility = "visible";
      document.getElementById("update_category_name").style.visibility = "visible";
      document.getElementById("update_category_name").required = true;

      document.getElementById("update_product_name_label").style.visibility = "visible";
      document.getElementById("update_product_name").style.visibility = "visible";
      document.getElementById("update_product_name").required = true;

      document.getElementById("update_product_price_label").style.visibility = "visible";
      document.getElementById("update_product_price").style.visibility = "visible";
      document.getElementById("update_product_price").required = true;

      document.getElementById("update_product_quantity_label").style.visibility = "visible";
      document.getElementById("update_product_quantity").style.visibility = "visible";
      document.getElementById("update_product_quantity").required = true;

      document.getElementById("update_product_sold_label").style.visibility = "visible";
      document.getElementById("update_product_sold").style.visibility = "visible";
      document.getElementById("update_product_sold").required = true;

      document.getElementById("update_product_image_label").style.visibility = "visible";
      document.getElementById("update_product_image").style.visibility = "visible";
      document.getElementById("update_item").style.visibility = "visible";
    }


    <!-----Hide inputs function----->


    <!-----// Table update function------>
    function updateTable() {

      <!------// Gets table body and clears it------->
      const tbody = document.getElementById("tbody");
      tbody.innerHTML = "";

      <!------// Fetches products from database------->
      fetch("/api/products").then((response) => {
      if (!response.ok) {
        throw new Error("Could not make network response");
      }
      return response.json();
      })

      <!-----// Goes through each row in the database and adds it to the HTML table using the addProductTable function----->
      .then((products) => {
        products.forEach((product) => {
          addProductTable(product);
        });
      })
      .catch((error) => {
        console.error("There was an issue when trying to fetch API: ", error);
      });
    }


    </script>
  </body>
</html>